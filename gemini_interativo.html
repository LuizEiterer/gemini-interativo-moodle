<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Interativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 bg-white rounded-lg shadow-lg">
        <div class="space-y-4">
            <textarea id="gemini-query" class="w-full h-24 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400" placeholder="Digite sua pergunta sobre o texto..."></textarea>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                <button id="ask-gemini-btn" class="w-full md:w-auto px-6 py-3 bg-[#34495e] text-white rounded-lg font-bold hover:bg-[#2c3e50] transition-colors duration-300 transform hover:scale-105">
                    Obter Resposta ‚ú®
                </button>
                <button id="new-prompt-btn" class="w-full md:w-auto px-6 py-3 bg-gray-300 text-gray-800 rounded-lg font-bold hover:bg-gray-400 transition-colors duration-300 transform hover:scale-105">
                    Gerar Novo T√≥pico para Debate
                </button>
            </div>
            <div id="gemini-response" class="mt-4 p-4 bg-white border border-gray-200 rounded-lg text-gray-700 leading-relaxed min-h-[50px]">
                <p>As respostas aparecer√£o aqui.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const askButton = document.getElementById('ask-gemini-btn');
            const newPromptButton = document.getElementById('new-prompt-btn');
            const queryInput = document.getElementById('gemini-query');
            const responseDiv = document.getElementById('gemini-response');
            
            // O texto da postagem ser√° enviado pelo postMessage do Moodle para o iframe
            let fullText = "Texto da postagem ainda n√£o carregado.";

            // Escuta a mensagem enviada pelo Moodle com o texto completo
            window.addEventListener('message', (event) => {
                if (event.data.text) {
                    fullText = event.data.text;
                }
            });

            // Envia uma mensagem para o Moodle pedindo o texto, caso o evento n√£o dispare automaticamente
            window.parent.postMessage({ type: 'requestText' }, '*');


            const apiKey = ""; // A chave da API ser√° fornecida pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            async function callGeminiAPI(userQuery) {
                responseDiv.innerHTML = '<p class="text-center text-gray-500">A pensar... üß†</p>';
                
                // Exponential backoff retry logic
                for (let i = 0; i < 3; i++) {
                    try {
                        const payload = {
                            contents: [{
                                parts: [
                                    { text: `Com base no texto a seguir, responda a pergunta do usu√°rio. Se a pergunta for irrelevante ou n√£o tiver rela√ß√£o com o texto, informe que n√£o pode responder. O texto √©:\n\n${fullText}\n\nPergunta do usu√°rio: ${userQuery}` }
                                ]
                            }],
                            systemInstruction: {
                                parts: [{ text: "Responda de forma concisa e √∫til, mantendo um tom acad√™mico e em portugu√™s." }]
                            },
                        };
            
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && i < 2) {
                                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                                continue;
                            }
                            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Desculpe, n√£o consegui gerar uma resposta. Tente novamente.';
                        responseDiv.innerHTML = `<p>${text}</p>`;
                        return;

                    } catch (error) {
                        responseDiv.innerHTML = `<p class="text-red-500">Erro: ${error.message}. Tente novamente mais tarde.</p>`;
                    }
                }
            }
            
            async function generateNewPrompt() {
                responseDiv.innerHTML = '<p class="text-center text-gray-500">A gerar um novo t√≥pico... üí°</p>';
                
                for (let i = 0; i < 3; i++) {
                    try {
                        const payload = {
                            contents: [{
                                parts: [
                                    { text: `Com base no texto a seguir sobre Foucault, Freire e a educa√ß√£o para a liberdade, gere uma nova pergunta criativa e aprofundada para debate em sala de aula ou em f√≥runs acad√™micos. O texto √©:\n\n${fullText}` }
                                ]
                            }],
                            systemInstruction: {
                                parts: [{ text: "Gere a pergunta de forma clara, concisa e estimulante, em portugu√™s." }]
                            },
                        };
            
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && i < 2) {
                                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                                continue;
                            }
                            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Desculpe, n√£o consegui gerar uma resposta. Tente novamente.';
                        responseDiv.innerHTML = `<p>${text}</p>`;
                        return;

                    } catch (error) {
                        responseDiv.innerHTML = `<p class="text-red-500">Erro: ${error.message}. Tente novamente mais tarde.</p>`;
                    }
                }
            }

            askButton.addEventListener('click', () => {
                const userQuery = queryInput.value.trim();
                if (userQuery) {
                    callGeminiAPI(userQuery);
                } else {
                    responseDiv.innerHTML = '<p class="text-red-500">Por favor, digite sua pergunta.</p>';
                }
            });

            newPromptButton.addEventListener('click', generateNewPrompt);
        });
    </script>
</body>
</html>
